<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Personal Finance Manager</title>
<style>
  /* ======== Embedded CSS ======== */
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    background: #f9f9f9;
    color: #333;
  }
  body.dark {
    background: #121212;
    color: #ddd;
  }
  header {
    background: #2c3e50;
    color: white;
    padding: 1rem;
    text-align: center;
  }
  body.dark header {
    background: #1e1e1e;
  }
  main {
    max-width: 900px;
    margin: 1rem auto;
    padding: 1rem;
    background: white;
    border-radius: 8px;
  }
  body.dark main {
    background: #222;
  }
  section {
    margin-bottom: 1.5rem;
  }
  h2 {
    margin-top: 0;
  }
  label {
    display: block;
    margin: 0.4rem 0 0.2rem;
  }
  input, select, textarea, button {
    font-size: 1rem;
    padding: 0.3rem 0.5rem;
    width: 100%;
    max-width: 400px;
    box-sizing: border-box;
    margin-bottom: 0.8rem;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  body.dark input, body.dark select, body.dark textarea {
    background: #333;
    border-color: #555;
    color: #ddd;
  }
  button {
    cursor: pointer;
    background: #2980b9;
    border: none;
    color: white;
    max-width: none;
    width: auto;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    transition: background 0.3s ease;
  }
  button:hover {
    background: #3498db;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0.5rem;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 0.5rem;
    text-align: left;
  }
  body.dark th, body.dark td {
    border-color: #444;
  }
  #chart-container {
    max-width: 100%;
    margin-top: 1rem;
  }
  #reminders-list li {
    margin-bottom: 0.5rem;
  }
  #reminders-list button {
    margin-left: 1rem;
    background: #c0392b;
  }
  #reminders-list button:hover {
    background: #e74c3c;
  }
  .flex-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }
  .flex-row > * {
    flex: 1;
    min-width: 150px;
  }
  #backup-area {
    width: 100%;
    height: 150px;
    font-family: monospace;
  }
</style>
</head>
<body>
<header>
  <h1>Personal Finance Manager</h1>
  <label>
    Dark Mode
    <input type="checkbox" id="dark-mode-toggle" />
  </label>
</header>
<main>
  <section id="auth-section">
    <h2>Login / Register</h2>
    <form id="auth-form">
      <label for="username-input">Username:</label>
      <input type="text" id="username-input" required />
      <label for="password-input">Password:</label>
      <input type="password" id="password-input" required />
      <button type="submit" id="auth-submit-btn">Login</button>
    </form>
    <button id="toggle-auth-btn">Switch to Register</button>
  </section>

  <section id="dashboard-section" style="display:none;">
    <button id="logout-btn">Logout</button>

    <section id="category-section">
      <h2>Categories</h2>
      <form id="category-form">
        <input type="text" id="category-input" placeholder="New category name" required />
        <button type="submit">Add Category</button>
      </form>
      <ul id="categories-list"></ul>
    </section>

    <section id="transaction-section">
      <h2>Transactions</h2>
      <form id="transaction-form">
        <label for="desc-input">Description:</label>
        <input type="text" id="desc-input" required />
        <label for="amount-input">Amount (use negative for expenses):</label>
        <input type="number" step="0.01" id="amount-input" required />
        <label for="category-select">Category:</label>
        <select id="category-select" required></select>
        <label for="date-input">Date:</label>
        <input type="date" id="date-input" required />
        <button type="submit">Add Transaction</button>
      </form>
      <table id="transactions-table">
        <thead>
          <tr><th>Description</th><th>Amount</th><th>Category</th><th>Date</th><th>Delete</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="summary-section">
      <h2>Summary</h2>
      <p>Total Income: <span id="total-income">0</span></p>
      <p>Total Expenses: <span id="total-expense">0</span></p>
      <p>Net Balance: <span id="net-balance">0</span></p>
    </section>

    <section id="chart-section">
      <h2>Monthly Income & Expenses</h2>
      <canvas id="monthly-chart" width="800" height="300"></canvas>
    </section>

    <section id="reminder-section">
      <h2>Reminders</h2>
      <form id="reminder-form">
        <input type="text" id="reminder-text" placeholder="Reminder text" required />
        <input type="datetime-local" id="reminder-date" required />
        <button type="submit">Add Reminder</button>
      </form>
      <ul id="reminders-list"></ul>
    </section>

    <section id="export-section">
      <h2>Export / Backup</h2>
      <button id="export-csv-btn">Export Transactions as CSV</button>
      <br /><br />
      <button id="backup-json-btn">Backup All Data (JSON)</button>
      <button id="restore-json-btn">Restore Data from JSON</button>
      <textarea id="backup-area" placeholder="Backup JSON data goes here..."></textarea>
    </section>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ======= Embedded JavaScript =======
  (function(){
    // Elements
    const authSection = document.getElementById('auth-section');
    const dashboardSection = document.getElementById('dashboard-section');
    const authForm = document.getElementById('auth-form');
    const usernameInput = document.getElementById('username-input');
    const passwordInput = document.getElementById('password-input');
    const authSubmitBtn = document.getElementById('auth-submit-btn');
    const toggleAuthBtn = document.getElementById('toggle-auth-btn');
    const logoutBtn = document.getElementById('logout-btn');

    const categoryForm = document.getElementById('category-form');
    const categoryInput = document.getElementById('category-input');
    const categoriesList = document.getElementById('categories-list');
    const categorySelect = document.getElementById('category-select');

    const transactionForm = document.getElementById('transaction-form');
    const descInput = document.getElementById('desc-input');
    const amountInput = document.getElementById('amount-input');
    const dateInput = document.getElementById('date-input');
    const transactionsTableBody = document.querySelector('#transactions-table tbody');

    const totalIncomeEl = document.getElementById('total-income');
    const totalExpenseEl = document.getElementById('total-expense');
    const netBalanceEl = document.getElementById('net-balance');

    const monthlyChartCtx = document.getElementById('monthly-chart').getContext('2d');
    let monthlyChart = null;

    const reminderForm = document.getElementById('reminder-form');
    const reminderTextInput = document.getElementById('reminder-text');
    const reminderDateInput = document.getElementById('reminder-date');
    const remindersList = document.getElementById('reminders-list');

    const exportCsvBtn = document.getElementById('export-csv-btn');
    const backupJsonBtn = document.getElementById('backup-json-btn');
    const restoreJsonBtn = document.getElementById('restore-json-btn');
    const backupArea = document.getElementById('backup-area');

    const darkModeToggle = document.getElementById('dark-mode-toggle');

    // State
    let isRegisterMode = false;
    let currentUser = null;
    let categories = [];
    let transactions = [];
    let reminders = [];

    // Utility functions
    function hashPassword(pw) {
      // Simple hash for demo (not secure for real apps)
      let hash = 0;
      for (let i = 0; i < pw.length; i++) {
        hash = ((hash << 5) - hash) + pw.charCodeAt(i);
        hash |= 0;
      }
      return hash.toString();
    }

    function saveUserData() {
      if (!currentUser) return;
      localStorage.setItem(`pfm_${currentUser}_categories`, JSON.stringify(categories));
      localStorage.setItem(`pfm_${currentUser}_transactions`, JSON.stringify(transactions));
      localStorage.setItem(`pfm_${currentUser}_reminders`, JSON.stringify(reminders));
    }

    function loadUserData() {
      if (!currentUser) return;
      categories = JSON.parse(localStorage.getItem(`pfm_${currentUser}_categories`)) || [];
      transactions = JSON.parse(localStorage.getItem(`pfm_${currentUser}_transactions`)) || [];
      reminders = JSON.parse(localStorage.getItem(`pfm_${currentUser}_reminders`)) || [];
    }

    function isLoggedIn() {
      return currentUser !== null;
    }

    function showAuth() {
      authSection.style.display = 'block';
      dashboardSection.style.display = 'none';
      usernameInput.value = '';
      passwordInput.value = '';
      authSubmitBtn.textContent = isRegisterMode ? 'Register' : 'Login';
      toggleAuthBtn.textContent = isRegisterMode ? 'Switch to Login' : 'Switch to Register';
    }

    function showDashboard() {
      authSection.style.display = 'none';
      dashboardSection.style.display = 'block';
      updateCategoriesUI();
      updateCategorySelect();
      updateTransactionsUI();
      updateSummary();
      updateChart();
      updateRemindersUI();
    }

    toggleAuthBtn.addEventListener('click', () => {
      isRegisterMode = !isRegisterMode;
      showAuth();
    });

    authForm.addEventListener('submit', e => {
      e.preventDefault();
      const username = usernameInput.value.trim();
      const password = passwordInput.value.trim();
      if (!username || !password) {
        alert('Please enter username and password.');
        return;
      }
      const users = JSON.parse(localStorage.getItem('pfm_users') || '{}');
      if (isRegisterMode) {
        if (users[username]) {
          alert('Username already exists. Choose another.');
          return;
        }
        users[username] = hashPassword(password);
        localStorage.setItem('pfm_users', JSON.stringify(users));
        alert('Registration successful. You can now log in.');
        isRegisterMode = false;
        showAuth();
      } else {
        if (!users[username] || users[username] !== hashPassword(password)) {
          alert('Invalid username or password.');
          return;
        }
        currentUser = username;
        localStorage.setItem('pfm_currentUser', currentUser);
        loadUserData();
        showDashboard();
      }
    });

    logoutBtn.addEventListener('click', () => {
      currentUser = null;
      localStorage.removeItem('pfm_currentUser');
      showAuth();
    });

    // Load currentUser on init
    currentUser = localStorage.getItem('pfm_currentUser');
    if (currentUser) {
      loadUserData();
      showDashboard();
    } else {
      showAuth();
    }

    // Categories

    categoryForm.addEventListener('submit', e => {
      e.preventDefault();
      const cat = categoryInput.value.trim();
      if (!cat) return;
      if (categories.includes(cat)) {
        alert('Category already exists.');
        return;
      }
      categories.push(cat);
      saveUserData();
      updateCategoriesUI();
      updateCategorySelect();
      categoryInput.value = '';
    });

    function updateCategoriesUI() {
      categoriesList.innerHTML = '';
      if (categories.length === 0) {
        categoriesList.innerHTML = '<li>No categories added.</li>';
        return;
      }
      categories.forEach(cat => {
        const li = document.createElement('li');
        li.textContent = cat;
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.style.marginLeft = '1rem';
        delBtn.onclick = () => {
          if (confirm(`Delete category "${cat}"? This will also remove transactions under this category.`)) {
            categories = categories.filter(c => c !== cat);
            transactions = transactions.filter(t => t.category !== cat);
            saveUserData();
            updateCategoriesUI();
            updateCategorySelect();
            updateTransactionsUI();
            updateSummary();
            updateChart();
          }
        };
        li.appendChild(delBtn);
        categoriesList.appendChild(li);
      });
    }

    function updateCategorySelect() {
      categorySelect.innerHTML = '';
      if (categories.length === 0) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'No categories';
        categorySelect.appendChild(opt);
        categorySelect.disabled = true;
      } else {
        categories.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat;
          opt.textContent = cat;
          categorySelect.appendChild(opt);
        });
        categorySelect.disabled = false;
      }
    }

    // Transactions

    transactionForm.addEventListener('submit', e => {
      e.preventDefault();
      if (categories.length === 0) {
        alert('Add a category first.');
        return;
      }
      const desc = descInput.value.trim();
      const amount = parseFloat(amountInput.value);
      const category = categorySelect.value;
      const date = dateInput.value;
      if (!desc || isNaN(amount) || !category || !date) {
        alert('Fill all transaction fields correctly.');
        return;
      }
      transactions.push({ desc, amount, category, date });
      saveUserData();
      updateTransactionsUI();
      updateSummary();
      updateChart();
      transactionForm.reset();
      dateInput.value = new Date().toISOString().split('T')[0];
    });

    function updateTransactionsUI() {
      transactionsTableBody.innerHTML = '';
      if (transactions.length === 0) {
        transactionsTableBody.innerHTML = '<tr><td colspan="5">No transactions added.</td></tr>';
        return;
      }
      transactions.forEach((t, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t.desc}</td>
          <td style="color:${t.amount >= 0 ? '#27ae60' : '#e74c3c'}">${t.amount.toFixed(2)}</td>
          <td>${t.category}</td>
          <td>${new Date(t.date).toLocaleDateString()}</td>
          <td><button aria-label="Delete transaction ${t.desc}">Delete</button></td>
        `;
        tr.querySelector('button').onclick = () => {
          if (confirm('Delete this transaction?')) {
            transactions.splice(i, 1);
            saveUserData();
            updateTransactionsUI();
            updateSummary();
            updateChart();
          }
        };
        transactionsTableBody.appendChild(tr);
      });
    }

    // Summary

    function updateSummary() {
      const income = transactions.filter(t => t.amount > 0).reduce((sum, t) => sum + t.amount, 0);
      const expense = transactions.filter(t => t.amount < 0).reduce((sum, t) => sum + t.amount, 0);
      totalIncomeEl.textContent = income.toFixed(2);
      totalExpenseEl.textContent = Math.abs(expense).toFixed(2);
      netBalanceEl.textContent = (income + expense).toFixed(2);
    }

    // Chart

    function updateChart() {
      if (!monthlyChart) {
        monthlyChart = new Chart(monthlyChartCtx, {
          type: 'bar',
          data: { labels: [], datasets: [] },
          options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
      }

      const months = [];
      const incomeData = [];
      const expenseData = [];
      const now = new Date();
      for(let i = 11; i >= 0; i--) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        months.push(d.toLocaleString('default', { month: 'short', year: 'numeric' }));
        incomeData.push(0);
        expenseData.push(0);
      }

      transactions.forEach(t => {
        const dt = new Date(t.date);
        for(let i = 0; i < 12; i++) {
          const d = new Date(now.getFullYear(), now.getMonth() - 11 + i, 1);
          if (dt.getFullYear() === d.getFullYear() && dt.getMonth() === d.getMonth()) {
            if (t.amount > 0) incomeData[i] += t.amount;
            else expenseData[i] += Math.abs(t.amount);
            break;
          }
        }
      });

      monthlyChart.data.labels = months;
      monthlyChart.data.datasets = [
        {
          label: 'Income',
          data: incomeData,
          backgroundColor: '#27ae60',
        },
        {
          label: 'Expenses',
          data: expenseData,
          backgroundColor: '#e74c3c',
        },
      ];
      monthlyChart.update();
    }

    // Reminders

    reminderForm.addEventListener('submit', e => {
      e.preventDefault();
      const text = reminderTextInput.value.trim();
      const datetime = reminderDateInput.value;
      if (!text || !datetime) return;
      reminders.push({ text, datetime });
      saveUserData();
      updateRemindersUI();
      reminderForm.reset();
    });

    function updateRemindersUI() {
      remindersList.innerHTML = '';
      if (reminders.length === 0) {
        remindersList.innerHTML = '<li>No reminders set.</li>';
        return;
      }
      reminders.forEach((r, i) => {
        const li = document.createElement('li');
        const dt = new Date(r.datetime);
        li.textContent = `${r.text} (at ${dt.toLocaleString()})`;
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.onclick = () => {
          if (confirm('Delete this reminder?')) {
            reminders.splice(i, 1);
            saveUserData();
            updateRemindersUI();
          }
        };
        li.appendChild(delBtn);
        remindersList.appendChild(li);
      });
    }

    // Reminder notifications (basic)

    setInterval(() => {
      const now = new Date();
      reminders.forEach((r, i) => {
        const dt = new Date(r.datetime);
        if (dt <= now) {
          alert(`Reminder: ${r.text}`);
          reminders.splice(i, 1);
          saveUserData();
          updateRemindersUI();
        }
      });
    }, 60000);

    // Export CSV

    exportCsvBtn.addEventListener('click', () => {
      if (transactions.length === 0) {
        alert('No transactions to export.');
        return;
      }
      const header = ['Description', 'Amount', 'Category', 'Date'];
      const rows = transactions.map(t => [
        `"${t.desc.replace(/"/g, '""')}"`,
        t.amount,
        `"${t.category.replace(/"/g, '""')}"`,
        t.date
      ]);
      let csvContent = header.join(',') + '\n' + rows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'transactions.csv';
      a.click();
      URL.revokeObjectURL(url);
    });

    // Backup & Restore JSON

    backupJsonBtn.addEventListener('click', () => {
      if (!isLoggedIn()) return;
      const data = {
        categories,
        transactions,
        reminders,
      };
      backupArea.value = JSON.stringify(data, null, 2);
      alert('Backup JSON created below.');
    });

    restoreJsonBtn.addEventListener('click', () => {
      if (!isLoggedIn()) return;
      if (!backupArea.value) {
        alert('Paste backup JSON data in the box to restore.');
        return;
      }
      try {
        const data = JSON.parse(backupArea.value);
        if (!data.categories || !data.transactions || !data.reminders) {
          alert('Invalid backup data.');
          return;
        }
        categories = data.categories;
        transactions = data.transactions;
        reminders = data.reminders;
        saveUserData();
        updateCategoriesUI();
        updateCategorySelect();
        updateTransactionsUI();
        updateSummary();
        updateChart();
        updateRemindersUI();
        alert('Data restored successfully.');
      } catch {
        alert('Invalid JSON format.');
      }
    });

    // Dark Mode toggle

    function applyDarkMode(isDark) {
      document.body.classList.toggle('dark', isDark);
      localStorage.setItem('pfm_darkMode', isDark ? '1' : '0');
    }

    darkModeToggle.addEventListener('change', e => {
      applyDarkMode(e.target.checked);
    });

    // Init dark mode
    const savedDarkMode = localStorage.getItem('pfm_darkMode');
    if (savedDarkMode === '1') {
      darkModeToggle.checked = true;
      applyDarkMode(true);
    }
  })();
</script>
</body>
</html>
