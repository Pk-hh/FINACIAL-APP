<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Advanced Finance Manager</title>
<link rel="manifest" href="manifest.json" />
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; background: #f2f2f2; color: #333;
    transition: background 0.3s, color 0.3s;
  }
  .dark {
    background: #121212;
    color: #eee;
  }
  .container {
    max-width: 480px;
    margin: auto;
    padding: 20px;
  }
  .box {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
  }
  .dark .box {
    background: #1e1e1e;
  }
  input, select, button, textarea {
    width: 100%;
    padding: 10px;
    margin-top: 8px;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  ul {
    list-style: none;
    padding: 0;
    margin-top: 10px;
    max-height: 220px;
    overflow-y: auto;
  }
  li {
    padding: 8px;
    margin: 6px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-left: 5px solid;
  }
  .income {
    border-color: green;
  }
  .expense {
    border-color: red;
  }
  .meta {
    font-size: 0.75em;
    opacity: 0.6;
  }
  .btn {
    padding: 5px 10px;
    margin-left: 4px;
    border: none;
    cursor: pointer;
    border-radius: 4px;
  }
  .delete { background: red; color: white; }
  .edit { background: orange; color: white; }
  .controls {
    display: flex;
    justify-content: space-between;
    gap: 5px;
    margin-top: 10px;
    flex-wrap: wrap;
  }
  .toggle {
    float: right;
    margin-top: -30px;
  }
  .summary {
    margin-top: 10px;
    font-size: 0.9em;
  }
  #loginBox {
    text-align: center;
    margin-top: 100px;
  }
  .hidden {
    display: none;
  }
  #voiceBtn {
    background-color: #2196F3;
    color: white;
  }
  #backupArea {
    height: 80px;
  }
  #budgetList li {
    flex-direction: column;
    align-items: flex-start;
  }
  #budgetList li > div {
    margin-top: 4px;
  }
  progress {
    width: 100%;
    height: 12px;
  }
</style>
</head>
<body>

<div id="loginBox">
  <h2>Enter Password</h2>
  <input type="password" id="password" placeholder="Password: 1234" autocomplete="off" />
  <button onclick="login()">Login</button>
</div>

<div class="container hidden" id="appBox">
  <div class="box">
    <h2>Advanced Finance Tracker</h2>
    
    <label for="desc">Description</label>
    <input type="text" id="desc" placeholder="e.g. Salary or Coffee" autocomplete="off" />

    <label for="category">Category</label>
    <select id="category">
      <option value="Salary">Salary</option>
      <option value="Food">Food</option>
      <option value="Transport">Transport</option>
      <option value="Entertainment">Entertainment</option>
      <option value="Shopping">Shopping</option>
      <option value="Other">Other</option>
    </select>

    <label for="amount">Amount (+ for income, - for expense)</label>
    <input type="number" id="amount" placeholder="e.g. 2000 or -100" autocomplete="off" />

    <button onclick="addTransaction()">Add Transaction</button>
    
    <button id="voiceBtn" onclick="startVoiceInput()">ðŸŽ¤ Voice Input</button>

    <input type="text" id="search" placeholder="Search description or category" oninput="render()" style="margin-top:10px;" />

    <div class="controls">
      <select onchange="setFilter(this.value)" id="filterSelect">
        <option value="all">All</option>
        <option value="income">Income</option>
        <option value="expense">Expense</option>
      </select>
      <button onclick="clearAll()">Clear All</button>
      <button onclick="downloadCSV()">Export CSV</button>
      <button onclick="backupData()">Backup Data</button>
      <button onclick="restoreData()">Restore Data</button>
    </div>

    <textarea id="backupArea" placeholder="Backup data will appear here or paste here to restore"></textarea>

    <h3>Balance: â‚¹<span id="balance">0.00</span></h3>
    <div class="summary">
      <p>This Month - Income: â‚¹<span id="monthIncome">0</span>, Expense: â‚¹<span id="monthExpense">0</span></p>
    </div>

    <h3>Budget Overview</h3>
    <ul id="budgetList"></ul>

    <ul id="list"></ul>

    <canvas id="chart" height="200"></canvas>

    <label class="toggle" title="Dark Mode Toggle">
      <input type="checkbox" onchange="toggleDarkMode()" />
      Dark Mode
    </label>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let data = JSON.parse(localStorage.getItem('financeData') || '[]');
  let budgets = JSON.parse(localStorage.getItem('financeBudgets') || '{}');
  let filter = 'all';

  function login() {
    const pass = document.getElementById('password').value;
    if (pass === '1234') {
      document.getElementById('loginBox').classList.add('hidden');
      document.getElementById('appBox').classList.remove('hidden');
      render();
    } else {
      alert("Wrong password!");
    }
  }

  function addTransaction() {
    const desc = document.getElementById('desc').value.trim();
    const amount = parseFloat(document.getElementById('amount').value);
    const category = document.getElementById('category').value;
    if (!desc || isNaN(amount)) return alert("Please enter valid description and amount.");
    data.push({
      desc,
      amount,
      category,
      date: new Date().toISOString()
    });
    saveData();
    render();
    document.getElementById('desc').value = '';
    document.getElementById('amount').value = '';
  }

  function editTransaction(index) {
    const newDesc = prompt("Edit description:", data[index].desc);
    const newAmt = prompt("Edit amount:", data[index].amount);
    const newCat = prompt("Edit category:", data[index].category);
    if (newDesc !== null && newAmt !== null && newCat !== null) {
      data[index].desc = newDesc.trim();
      data[index].amount = parseFloat(newAmt);
      data[index].category = newCat.trim();
      saveData();
      render();
    }
  }

  function deleteTransaction(index) {
    if (confirm("Delete this entry?")) {
      data.splice(index, 1);
      saveData();
      render();
    }
  }

  function clearAll() {
    if (confirm("Clear all transactions?")) {
      data = [];
      saveData();
      render();
    }
  }

  function saveData() {
    localStorage.setItem('financeData', JSON.stringify(data));
    localStorage.setItem('financeBudgets', JSON.stringify(budgets));
  }

  function setFilter(type) {
    filter = type;
    render();
  }

  function render() {
    const list = document.getElementById('list');
    const balanceEl = document.getElementById('balance');
    const incomeEl = document.getElementById('monthIncome');
    const expenseEl = document.getElementById('monthExpense');
    const budgetList = document.getElementById('budgetList');
    const searchText = document.getElementById('search').value.toLowerCase();
    list.innerHTML = '';
    budgetList.innerHTML = '';
    let balance = 0;
    let income = 0, expense = 0;
    const now = new Date();

    // Calculate totals and filter display
    let filteredData = data.filter(t => {
      if (filter === 'income' && t.amount <= 0) return false;
      if (filter === 'expense' && t.amount >= 0) return false;
      if (searchText && !t.desc.toLowerCase().includes(searchText) && !t.category.toLowerCase().includes(searchText)) return false;
      return true;
    });

    filteredData.forEach((t, i) => {
      balance += t.amount;
      const tDate = new Date(t.date);
      if (tDate.getMonth() === now.getMonth() && tDate.getFullYear() === now.getFullYear()) {
        if (t.amount > 0) income += t.amount; else expense += t.amount;
      }
      const li = document.createElement('li');
      li.className = t.amount >= 0 ? 'income' : 'expense';
      li.style.borderLeftColor = t.amount >= 0 ? 'green' : 'red';

      li.innerHTML = `
        <div><strong>${t.desc}</strong> (${t.category})</div>
        <div>â‚¹${t.amount.toFixed(2)}<br/><span class="meta">${new Date(t.date).toLocaleDateString()}</span></div>
        <div>
          <button class="btn edit" onclick="editTransaction(${i})">Edit</button>
          <button class="btn delete" onclick="deleteTransaction(${i})">Del</button>
        </div>
      `;
      list.appendChild(li);
    });

    balanceEl.textContent = balance.toFixed(2);
    incomeEl.textContent = income.toFixed(2);
    expenseEl.textContent = Math.abs(expense).toFixed(2);

    // Show budget list
    for (const [cat, limit] of Object.entries(budgets)) {
      let spent = data
        .filter(t => t.category === cat && t.amount < 0)
        .reduce((a, b) => a + Math.abs(b.amount), 0);
      let progress = Math.min(100, (spent / limit) * 100);
      const li = document.createElement('li');
      li.innerHTML = `
        <strong>${cat}</strong> - Budget: â‚¹${limit.toFixed(2)}<br/>
        <div>Spent: â‚¹${spent.toFixed(2)} <progress value="${spent}" max="${limit}"></progress> ${progress.toFixed(1)}%</div>
        <button onclick="setBudget('${cat}')">Set Budget</button>
      `;
      budgetList.appendChild(li);
    }

    updateChart();
  }

  function setBudget(cat) {
    let val = prompt(`Set monthly budget limit for ${cat}:`, budgets[cat] || '');
    if (val !== null) {
      let num = parseFloat(val);
      if (isNaN(num) || num < 0) return alert('Invalid number');
      budgets[cat] = num;
      saveData();
      render();
    }
  }

  // Chart.js pie chart
  let chartInstance = null;
  function updateChart() {
    const ctx = document.getElementById('chart').getContext('2d');
    const incomeCat = {};
    const expenseCat = {};

    data.forEach(t => {
      if (t.amount > 0) incomeCat[t.category] = (incomeCat[t.category] || 0) + t.amount;
      else expenseCat[t.category] = (expenseCat[t.category] || 0) + Math.abs(t.amount);
    });

    const incomeLabels = Object.keys(incomeCat);
    const incomeData = Object.values(incomeCat);
    const expenseLabels = Object.keys(expenseCat);
    const expenseData = Object.values(expenseCat);

    const datasets = [];

    if (incomeData.length) {
      datasets.push({
        label: 'Income',
        data: incomeData,
        backgroundColor: incomeLabels.map(() => 'rgba(54, 162, 235, 0.7)'),
      });
    }
    if (expenseData.length) {
      datasets.push({
        label: 'Expense',
        data: expenseData,
        backgroundColor: expenseLabels.map(() => 'rgba(255, 99, 132, 0.7)'),
      });
    }

    if (chartInstance) {
      chartInstance.destroy();
    }

    chartInstance = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: incomeLabels.concat(expenseLabels),
        datasets: [{
          data: incomeData.concat(expenseData),
          backgroundColor: incomeLabels.map(() => 'rgba(54, 162, 235, 0.7)')
                          .concat(expenseLabels.map(() => 'rgba(255, 99, 132, 0.7)'))
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  }

  function downloadCSV() {
    let csv = 'Description,Category,Amount,Date\n';
    data.forEach(t => {
      csv += `"${t.desc}","${t.category}",${t.amount},"${t.date}"\n`;
    });
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'finance_data.csv';
    a.click();
    URL.revokeObjectURL(url);
  }

  function backupData() {
    const backupArea = document.getElementById('backupArea');
    backupArea.value = JSON.stringify({data, budgets}, null, 2);
    alert('Backup data copied below. You can save it externally.');
  }

  function restoreData() {
    const backupArea = document.getElementById('backupArea');
    try {
      const obj = JSON.parse(backupArea.value);
      if (obj.data && obj.budgets) {
        data = obj.data;
        budgets = obj.budgets;
        saveData();
        render();
        alert('Data restored!');
      } else {
        alert('Invalid backup data');
      }
    } catch(e) {
      alert('Invalid JSON');
    }
  }

  // Dark mode toggle
  function toggleDarkMode() {
    document.body.classList.toggle('dark');
  }

  // Voice input for description and amount
  function startVoiceInput() {
    if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
      return alert('Your browser does not support speech recognition.');
    }
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    recognition.start();

    recognition.onresult = function(event) {
      const speech = event.results[0][0].transcript.toLowerCase();
      // Basic parsing: look for keywords "income" or "expense" and amount
      // Format expected: "income 5000 salary" or "expense 200 food"
      const words = speech.split(' ');
      let type = null;
      let amt = null;
      let descWords = [];
      words.forEach(w => {
        if (w === 'income' || w === 'credit' || w === 'salary') type = 'income';
        else if (w === 'expense' || w === 'debit' || w === 'spent' || w === 'cost') type = 'expense';
        else if (!isNaN(parseFloat(w))) amt = parseFloat(w);
        else descWords.push(w);
      });
      let desc = descWords.join(' ') || 'Voice Input';

      if (type === 'income') amt = amt || 0;
      else if (type === 'expense') amt = amt ? -Math.abs(amt) : 0;

      if (amt === null) {
        return alert('Could not recognize amount in speech.');
      }

      document.getElementById('desc').value = desc;
      document.getElementById('amount').value = amt;
      document.getElementById('category').value = 'Other';
    };

    recognition.onerror = function(event) {
      alert('Speech recognition error: ' + event.error);
    };
  }

  // Initial render
  render();

</script>
</body>
</html>
