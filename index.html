<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Personal Finance Manager</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#4CAF50" />
  <style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

* {
  box-sizing: border-box;
}

body {
  margin: 0; padding: 0;
  font-family: 'Inter', sans-serif;
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  color: #2e3440;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 30px 20px;
  transition: background-color 0.4s ease, color 0.4s ease;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

h1 {
  font-weight: 700;
  color: #1f2937;
  margin-bottom: 1.2rem;
  user-select: none;
  text-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

button {
  cursor: pointer;
  border: none;
  background: linear-gradient(135deg, #43cea2, #185a9d);
  color: white;
  padding: 12px 28px;
  font-weight: 600;
  border-radius: 12px;
  box-shadow: 0 8px 15px rgba(67, 206, 162, 0.4);
  font-size: 1rem;
  transition:
    background 0.4s ease,
    box-shadow 0.4s ease,
    transform 0.15s ease;
  user-select: none;
}
button:hover:not(:disabled) {
  background: linear-gradient(135deg, #2a8a67, #123f5e);
  box-shadow: 0 12px 20px rgba(42, 138, 103, 0.6);
  transform: translateY(-2px);
}
button:disabled {
  background: #a5d6a7;
  cursor: not-allowed;
  box-shadow: none;
  transform: none;
}

input, select, textarea {
  font-family: 'Inter', sans-serif;
  padding: 14px 16px;
  border-radius: 14px;
  border: 2px solid #d1d9e6;
  outline-offset: 3px;
  outline-color: transparent;
  font-size: 1rem;
  width: 100%;
  max-width: 320px;
  margin-bottom: 18px;
  background: white;
  transition:
    border-color 0.4s ease,
    box-shadow 0.3s ease,
    background-color 0.3s ease;
  box-shadow: inset 0 2px 6px rgb(0 0 0 / 0.05);
  user-select: text;
}
input:focus, select:focus, textarea:focus {
  border-color: #43cea2;
  outline-color: #43cea2;
  box-shadow: 0 0 8px #43cea2aa;
  background-color: #f0fdf9;
}

.container {
  width: 100%;
  max-width: 900px;
  background: white;
  border-radius: 24px;
  box-shadow:
    0 16px 40px rgba(0,0,0,0.07),
    0 0 0 1px rgba(0,0,0,0.03);
  padding: 40px 48px;
  margin-bottom: 48px;
  transition: box-shadow 0.3s ease;
}
.container:hover {
  box-shadow:
    0 24px 60px rgba(0,0,0,0.1),
    0 0 0 1px rgba(0,0,0,0.04);
}

form {
  display: flex;
  flex-wrap: wrap;
  gap: 18px 30px;
}
form > * {
  flex: 1 1 220px;
  min-width: 180px;
}

ul {
  list-style: none;
  padding-left: 0;
  max-width: 600px;
  margin: 0 auto;
}
ul li {
  background: #d9f0e1;
  margin-bottom: 14px;
  padding: 16px 24px;
  border-radius: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow:
    0 8px 12px rgb(0 0 0 / 0.06);
  transition:
    background-color 0.3s ease,
    box-shadow 0.3s ease;
  font-weight: 600;
  color: #256d3b;
}
ul li:hover {
  background: #b6dfbf;
  box-shadow:
    0 10px 20px rgb(0 0 0 / 0.1);
}
ul li button {
  background: #e74c3c;
  padding: 8px 14px;
  font-size: 0.9rem;
  border-radius: 14px;
  box-shadow:
    0 5px 12px rgba(231, 76, 60, 0.5);
  transition:
    background-color 0.3s ease,
    box-shadow 0.3s ease,
    transform 0.1s ease;
}
ul li button:hover {
  background-color: #c0392b;
  box-shadow: 0 8px 16px rgba(192, 57, 43, 0.7);
  transform: translateY(-2px);
}

#chart-container {
  margin-top: 40px;
  max-width: 720px;
  width: 100%;
}

body.dark {
  background: linear-gradient(135deg, #121212 0%, #2a2a2a 100%);
  color: #ccc;
}
body.dark .container {
  background: #1e1e1e;
  box-shadow:
    0 16px 40px rgba(255,255,255,0.05),
    0 0 0 1px rgba(255,255,255,0.07);
}
body.dark input, body.dark select, body.dark textarea {
  background-color: #222;
  border-color: #444;
  color: #ddd;
  box-shadow: inset 0 2px 6px rgb(255 255 255 / 0.06);
}
body.dark input:focus, body.dark select:focus, body.dark textarea:focus {
  border-color: #43cea2;
  outline-color: #43cea2;
  box-shadow: 0 0 12px #43cea2cc;
}
body.dark ul li {
  background: #333;
  color: #a3d9b1;
  box-shadow:
    0 8px 12px rgba(255,255,255,0.05);
}
body.dark ul li:hover {
  background: #444;
  box-shadow:
    0 10px 20px rgba(255,255,255,0.1);
}
body.dark ul li button {
  background-color: #e74c3c;
  box-shadow: none;
}
body.dark ul li button:hover {
  background-color: #c0392b;
}

@media (max-width: 600px) {
  form {
    flex-direction: column;
  }
  form > * {
    flex: 1 1 100%;
    max-width: 100%;
  }
  .container {
    padding: 30px 24px;
  }
}

label[for="darkModeToggle"] {
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 10px;
  font-weight: 600;
  font-size: 1rem;
  user-select: none;
  color: #2c3e50;
  margin-bottom: 25px;
  transition: color 0.3s ease;
}
body.dark label[for="darkModeToggle"] {
  color: #8bcbbf;
}
input[type="checkbox"] {
  width: 24px;
  height: 24px;
  accent-color: #43cea2;
  cursor: pointer;
  transition: accent-color 0.3s ease;
}
input[type="checkbox"]:hover {
  accent-color: #2a8a67;
}
</style>
</head>
<body>
<h1>FINANCIAL MANAGER</h1>

<div class="container" id="auth-section">
  <form id="authForm">
    <input type="text" id="usernameInput" placeholder="Username" required />
    <input type="password" id="passwordInput" placeholder="Password" required />
    <button type="submit" id="authSubmitBtn">Login / Register</button>
  </form>
</div>

<div class="container" id="main-section" style="display:none;">
  <button id="logoutBtn" style="float:right; background:#f44336;">Logout</button>
  <h2>Welcome, <span id="currentUser"></span></h2>

  <section>
    <h3>Categories</h3>
    <form id="categoryForm">
      <input type="text" id="categoryNameInput" placeholder="Category name" required />
      <button type="submit">Add Category</button>
    </form>
    <ul id="categoryList"></ul>
  </section>

  <section>
    <h3>Transactions</h3>
    <form id="transactionForm">
      <input type="text" id="descInput" placeholder="Description" required />
      <input type="number" id="amountInput" placeholder="Amount" required step="0.01" />
      <select id="categorySelect" required></select>
      <input type="date" id="dateInput" required />
      <button type="submit">Add Transaction</button>
    </form>
    <ul id="transactionList"></ul>
  </section>

  <section>
    <h3>Summary</h3>
    <p>Total Income: <span id="totalIncome">$0.00</span></p>
    <p>Total Expense: <span id="totalExpense">$0.00</span></p>
  </section>

  <section id="chart-container">
    <canvas id="monthlyChart" width="700" height="300"></canvas>
  </section>

  <section>
    <h3>Reminders</h3>
    <form id="reminderForm">
      <input type="text" id="reminderTextInput" placeholder="Reminder text" required />
      <input type="datetime-local" id="reminderDateInput" required />
      <button type="submit">Add Reminder</button>
    </form>
    <ul id="remindersList"></ul>
  </section>

  <section style="margin-top:20px;">
    <button id="exportCsvBtn">Export Transactions CSV</button>
    <button id="backupJsonBtn">Backup Data (JSON)</button>
    <button id="restoreJsonBtn">Restore Data (JSON)</button>
    <textarea id="backupArea" rows="6" style="width:100%; margin-top:10px;" placeholder="Backup JSON will appear here or paste JSON to restore"></textarea>
  </section>

  <section style="margin-top: 20px;">
    <label for="darkModeToggle">
      <input type="checkbox" id="darkModeToggle" />
      Dark Mode
    </label>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
  // Elements
  const authSection = document.getElementById('auth-section');
  const mainSection = document.getElementById('main-section');
  const authForm = document.getElementById('authForm');
  const usernameInput = document.getElementById('usernameInput');
  const passwordInput = document.getElementById('passwordInput');
  const authSubmitBtn = document.getElementById('authSubmitBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const currentUserSpan = document.getElementById('currentUser');

  const categoryForm = document.getElementById('categoryForm');
  const categoryNameInput = document.getElementById('categoryNameInput');
  const categoryList = document.getElementById('categoryList');

  const transactionForm = document.getElementById('transactionForm');
  const descInput = document.getElementById('descInput');
  const amountInput = document.getElementById('amountInput');
  const categorySelect = document.getElementById('categorySelect');
  const dateInput = document.getElementById('dateInput');
  const transactionList = document.getElementById('transactionList');

  const totalIncomeSpan = document.getElementById('totalIncome');
  const totalExpenseSpan = document.getElementById('totalExpense');

  const reminderForm = document.getElementById('reminderForm');
  const reminderTextInput = document.getElementById('reminderTextInput');
  const reminderDateInput = document.getElementById('reminderDateInput');
  const remindersList = document.getElementById('remindersList');

  const exportCsvBtn = document.getElementById('exportCsvBtn');
  const backupJsonBtn = document.getElementById('backupJsonBtn');
  const restoreJsonBtn = document.getElementById('restoreJsonBtn');
  const backupArea = document.getElementById('backupArea');

  const darkModeToggle = document.getElementById('darkModeToggle');

  // Data keys
  const USERS_KEY = 'pfm_users';
  const LOGGED_USER_KEY = 'pfm_loggedUser';

  let currentUser = null;
  let users = {};

  // Load users from localStorage
  function loadUsers() {
    users = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
  }

  // Save users to localStorage
  function saveUsers() {
    localStorage.setItem(USERS_KEY, JSON.stringify(users));
  }

  // Login/Register handler
  authForm.addEventListener('submit', e => {
    e.preventDefault();
    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();
    if (!username || !password) return alert('Enter username and password');
    loadUsers();
    if (users[username]) {
      // User exists: check password
      if (users[username].password !== password) {
        alert('Incorrect password');
        return;
      }
    } else {
      // Register new user
      users[username] = {
        password,
        categories: ['General'],
        transactions: [],
        reminders: []
      };
      saveUsers();
      alert('User registered! You are now logged in.');
    }
    currentUser = username;
    localStorage.setItem(LOGGED_USER_KEY, currentUser);
    initApp();
  });

  // Logout
  logoutBtn.addEventListener('click', () => {
    currentUser = null;
    localStorage.removeItem(LOGGED_USER_KEY);
    mainSection.style.display = 'none';
    authSection.style.display = 'block';
  });

  // Init app after login
  function initApp() {
    loadUsers();
    if (!currentUser || !users[currentUser]) {
      authSection.style.display = 'block';
      mainSection.style.display = 'none';
      return;
    }
    authSection.style.display = 'none';
    mainSection.style.display = 'block';
    currentUserSpan.textContent = currentUser;
    renderCategories();
    renderTransactions();
    renderReminders();
    updateSummary();
    updateCategorySelect();
    renderChart();
  }

  // Categories
  categoryForm.addEventListener('submit', e => {
    e.preventDefault();
    const catName = categoryNameInput.value.trim();
    if (!catName) return;
    if (users[currentUser].categories.includes(catName)) {
      alert('Category already exists');
      return;
    }
    users[currentUser].categories.push(catName);
    saveUsers();
    categoryNameInput.value = '';
    renderCategories();
    updateCategorySelect();
  });

  function renderCategories() {
    categoryList.innerHTML = '';
    users[currentUser].categories.forEach(cat => {
      const li = document.createElement('li');
      li.textContent = cat;
      const btn = document.createElement('button');
      btn.textContent = 'Delete';
      btn.onclick = () => {
        if (!confirm(`Delete category "${cat}"? All transactions in this category will also be deleted.`)) return;
        users[currentUser].categories = users[currentUser].categories.filter(c => c !== cat);
        // Also delete transactions in this category
        users[currentUser].transactions = users[currentUser].transactions.filter(t => t.category !== cat);
        saveUsers();
        renderCategories();
        renderTransactions();
        updateSummary();
        updateCategorySelect();
        renderChart();
      };
      li.appendChild(btn);
      categoryList.appendChild(li);
    });
  }

  // Transactions
  transactionForm.addEventListener('submit', e => {
    e.preventDefault();
    const desc = descInput.value.trim();
    const amount = parseFloat(amountInput.value);
    const category = categorySelect.value;
    const date = dateInput.value;
    if (!desc || !category || !date || isNaN(amount)) return alert('Please fill all transaction fields correctly');
    users[currentUser].transactions.push({
      id: crypto.randomUUID(),
      description: desc,
      amount,
      category,
      date
    });
    saveUsers();
    descInput.value = '';
    amountInput.value = '';
    dateInput.value = '';
    renderTransactions();
    updateSummary();
    renderChart();
  });

  function renderTransactions() {
    transactionList.innerHTML = '';
    users[currentUser].transactions
      .sort((a,b) => new Date(b.date) - new Date(a.date))
      .forEach(t => {
      const li = document.createElement('li');
      const sign = t.amount >= 0 ? '+' : '-';
      const amountText = `${sign}$${Math.abs(t.amount).toFixed(2)}`;
      li.innerHTML = `<strong>${t.description}</strong> <em>${t.category}</em> <span>${t.date}</span> <span>${amountText}</span>`;
      const btn = document.createElement('button');
      btn.textContent = 'Delete';
      btn.onclick = () => {
        if (!confirm('Delete this transaction?')) return;
        users[currentUser].transactions = users[currentUser].transactions.filter(tr => tr.id !== t.id);
        saveUsers();
        renderTransactions();
        updateSummary();
        renderChart();
      };
      li.appendChild(btn);
      transactionList.appendChild(li);
    });
  }

  // Update categories select
  function updateCategorySelect() {
    categorySelect.innerHTML = '';
    users[currentUser].categories.forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat;
      opt.textContent = cat;
      categorySelect.appendChild(opt);
    });
  }

  // Summary
  function updateSummary() {
    const transactions = users[currentUser].transactions;
    let income = 0, expense = 0;
    transactions.forEach(t => {
      if (t.amount >= 0) income += t.amount;
      else expense += Math.abs(t.amount);
    });
    totalIncomeSpan.textContent = `$${income.toFixed(2)}`;
    totalExpenseSpan.textContent = `$${expense.toFixed(2)}`;
  }

  // Chart (Monthly income vs expense)
  let chartInstance = null;
  function renderChart() {
    if (!chartInstance) {
      const ctx = document.getElementById('monthlyChart').getContext('2d');
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: [], datasets: []
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          },
          plugins: {
            legend: { position: 'top' },
            title: {
              display: true,
              text: 'Monthly Income and Expense'
            }
          }
        }
      });
    }
    // Aggregate data monthly
    const dataByMonth = {};
    users[currentUser].transactions.forEach(t => {
      const d = new Date(t.date);
      if (isNaN(d)) return;
      const key = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}`;
      if (!dataByMonth[key]) dataByMonth[key] = { income:0, expense:0 };
      if (t.amount >= 0) dataByMonth[key].income += t.amount;
      else dataByMonth[key].expense += Math.abs(t.amount);
    });
    const sortedKeys = Object.keys(dataByMonth).sort();
    const labels = sortedKeys;
    const incomeData = sortedKeys.map(k => dataByMonth[k].income.toFixed(2));
    const expenseData = sortedKeys.map(k => dataByMonth[k].expense.toFixed(2));

    chartInstance.data.labels = labels;
    chartInstance.data.datasets = [
      { label: 'Income', data: incomeData, backgroundColor: '#4caf50' },
      { label: 'Expense', data: expenseData, backgroundColor: '#f44336' }
    ];
    chartInstance.update();
  }

  // Reminders
  reminderForm.addEventListener('submit', e => {
    e.preventDefault();
    const text = reminderTextInput.value.trim();
    const datetime = reminderDateInput.value;
    if (!text || !datetime) return alert('Fill reminder text and date/time');
    users[currentUser].reminders.push({
      id: crypto.randomUUID(),
      text,
      datetime
    });
    saveUsers();
    reminderTextInput.value = '';
    reminderDateInput.value = '';
    renderReminders();
  });

  function renderReminders() {
    remindersList.innerHTML = '';
    users[currentUser].reminders
      .sort((a,b) => new Date(a.datetime) - new Date(b.datetime))
      .forEach(r => {
      const li = document.createElement('li');
      li.textContent = `${r.text} - ${new Date(r.datetime).toLocaleString()}`;
      const btn = document.createElement('button');
      btn.textContent = 'Delete';
      btn.onclick = () => {
        if (!confirm('Delete this reminder?')) return;
        users[currentUser].reminders = users[currentUser].reminders.filter(rem => rem.id !== r.id);
        saveUsers();
        renderReminders();
      };
      li.appendChild(btn);
      remindersList.appendChild(li);
    });
  }

  // Export CSV of transactions
  exportCsvBtn.addEventListener('click', () => {
    const transactions = users[currentUser].transactions;
    if (!transactions.length) return alert('No transactions to export');
    let csv = 'Description,Category,Date,Amount\n';
    transactions.forEach(t => {
      csv += `"${t.description.replace(/"/g, '""')}","${t.category}",${t.date},${t.amount}\n`;
    });
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${currentUser}_transactions.csv`;
    a.click();
    URL.revokeObjectURL(url);
  });

  // Backup JSON
  backupJsonBtn.addEventListener('click', () => {
    backupArea.value = JSON.stringify(users[currentUser], null, 2);
  });

  // Restore JSON
  restoreJsonBtn.addEventListener('click', () => {
    try {
      const data = JSON.parse(backupArea.value);
      if (!data) throw new Error('Invalid data');
      // Simple validation
      if (!data.categories || !data.transactions || !data.reminders) {
        throw new Error('Missing required fields in data');
      }
      users[currentUser] = data;
      saveUsers();
      initApp();
      alert('Data restored!');
    } catch (err) {
      alert('Failed to restore data: ' + err.message);
    }
  });

  // Dark mode toggle
  function applyDarkMode(enabled) {
    if (enabled) {
      document.body.classList.add('dark');
      localStorage.setItem('pfm_darkMode', 'true');
      darkModeToggle.checked = true;
    } else {
      document.body.classList.remove('dark');
      localStorage.setItem('pfm_darkMode', 'false');
      darkModeToggle.checked = false;
    }
  }
  darkModeToggle.addEventListener('change', () => {
    applyDarkMode(darkModeToggle.checked);
  });
  // Load dark mode preference
  const darkModePref = localStorage.getItem('pfm_darkMode') === 'true';
  applyDarkMode(darkModePref);

  // Check logged in user on load
  window.addEventListener('load', () => {
    loadUsers();
    const loggedUser = localStorage.getItem(LOGGED_USER_KEY);
    if (loggedUser && users[loggedUser]) {
      currentUser = loggedUser;
      initApp();
    }
  });

  // Register service worker for PWA
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').then(() => {
      console.log('Service Worker Registered');
    });
  }
})();
</script>
</body>
</html>
